@page "/"
@page "/login"
@using FileManager.Maui.Services
@using FileManager.Shared.DTOs
@using Blazored.LocalStorage
@inject ApiService Api
@inject ILocalStorageService LocalStorage
@inject NavigationManager Navigation

<style>
    .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .auth-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 400px; }
    .auth-icon { width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; color: white; font-size: 40px; }
    .auth-title { margin: 0; font-size: 28px; color: #2d3748; text-align: center; }
    .auth-subtitle { color: #718096; margin-top: 8px; text-align: center; }
    .error { background: #fed7d7; color: #c53030; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; color: #4a5568; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
    .form-input { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: all 0.3s; }
    .form-input:focus { outline: none; border-color: #667eea; }
    .btn-submit { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
    .btn-submit:hover:not(:disabled) { transform: translateY(-2px); }
    .btn-submit:disabled { cursor: not-allowed; opacity: 0.6; }
    .auth-footer { margin-top: 24px; text-align: center; color: #718096; font-size: 14px; }
    .auth-link { background: none; border: none; color: #667eea; cursor: pointer; font-weight: 600; text-decoration: none; }
</style>

<div class="auth-container">
    <div class="auth-card">
        <div class="auth-icon">üìÅ</div>
        <h1 class="auth-title">Welcome Back</h1>
        <p class="auth-subtitle">Sign in to your account</p>
        
        @if (!string.IsNullOrEmpty(error))
        {
            <div class="error">@error</div>
        }

        <EditForm Model="@loginRequest" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />
            
            <div class="form-group">
                <label class="form-label">Username</label>
                <InputText @bind-Value="loginRequest.Username" 
                           placeholder="Enter your username" 
                           class="form-input"
                           disabled="@loading" />
                <ValidationMessage For="@(() => loginRequest.Username)" />
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <InputText type="password" 
                           @bind-Value="loginRequest.Password" 
                           placeholder="Enter your password" 
                           class="form-input"
                           disabled="@loading" />
                <ValidationMessage For="@(() => loginRequest.Password)" />
            </div>

            <button type="submit" class="btn-submit" disabled="@loading">
                @(loading ? "Signing in..." : "Sign In")
            </button>
        </EditForm>

        <div class="auth-footer">
            Don't have an account? 
            <button @onclick="@(() => Navigation.NavigateTo("/register"))" class="auth-link">
                Create one
            </button>
        </div>
    </div>
</div>

@code {
    private LoginRequest loginRequest = new();
    private string error = "";
    private bool loading = false;

    private async Task HandleLogin()
    {
        error = "";
        loading = true;

        try
        {
            var response = await Api.LoginAsync(loginRequest);
            await LocalStorage.SetItemAsStringAsync("token", response.Token);
            await LocalStorage.SetItemAsStringAsync("username", response.Username);
            await LocalStorage.SetItemAsStringAsync("userId", response.UserId.ToString());
            Navigation.NavigateTo("/files-maui");
        }
        catch
        {
            error = "Invalid credentials";
        }
        finally
        {
            loading = false;
        }
    }
}